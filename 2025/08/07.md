## 取り組んだ課題一覧
- 現場で使えるDjangoの教科書
	
## わかったこと

### ミドルウェア（Middleware）

#### メッセージフレームワーク（MessageMiddleware）

- フラッシュメッセージを表示する例
```
# views.py

from django.contrib import messages
from django.http.response import HttpResponseRedirect
from django.urls import reverse
from django.views import View


class LoginView(View):
    ....
    def post(self, request, *args, **kwargs):
    # フラッシュメッセージを表示
    messages.info(request, 'ログインしました')
    return HttpResponseRedirect(reverse('shop:index'))
```
```
# message.html

# messages という コンテキスト変数がテンプレートに自動的に渡される（ビュー側で記述不要）
{% for message in messages %}
    # tags（例: "info", "success", "error"）→ Bootstrap のクラスなどに使える
    <div class="alert alert-{{ message.tags }}" role="alert">
        <span>{{ message }}</span>
    </div>
{% endfor %}
```

### 設定ファイル（settings.py）

#### アプリケーション

- `INSTALLED_APPS`：インストールするアプリケーションをリスト形式で列挙する
```
INSTALLED_APPS = [
      ... （略）...  
    'accounts.apps.AccountsConfig',  # 自作のアプリケーションは下に書いていく
    'shop.apps.ShopConfig',  
    ] 
```
- `DEBUG`：開発時はTrueに、本番はFalseにする
```
DEBUG = False
```

#### 静的ファイル（CSSや画像）

- 静的ファイル関連の設定
```
# 静的ファイルのパスを示すURL
STATIC_URL = 'static/'
# リスト型で複数のディレクトリを管理できる（アプリごとに分ける場合など）
STATICFILES_DIRS = [BASE_DIR / 'static']
# リバースプロキシで静的ファイルを配信する場合の配信元ディレクトリ
# 本番環境でSTATICFILES_DIRSを一つにまとめる際に必要
# 開発環境でも無いとエラーになるため書いておく
STATIC_ROOT = f'/var/www/{BASE_DIR.name}/static'
```
- 静的ファイルはアプリケーションサーバではなくリバースプロキシサーバで捌くことで、負荷分散やセキュリティ対策となる
- 本番環境では`STATIC_ROOT`設定後、`$ python manage.py collectstatic`を実行することで、静的ファイルをリバースプロキシサーバ（STATIC_ROOT配下）にコピーする
- テンプレートで静的ファイルの画像を表示する
```
{% load static %}

<img src="{% static 'shop/images/no-image.png' %}">
```
- メディアファイル（本番用の例）
```
# メディア（画像）ファイルのパスを示すURL
MEDIA_URL = '/media/'
# メディアファイルのアップロード先ディレクトリ
# また、リバースプロキシでメディアファイルを配信する場合の配信元ディレクトリ
MEDIA_ROOT = f'/var/www/{BASE_DIR.name}/media'
```
- メディアファイルの保存
```
# form.py

class ProfileChangeForm(forms.ModelForm):
    """プロフィール変更画面用のフォーム"""

    class Meta:
        model = CustomUser
        fields = ('email', 'profile_image')
```
```
# views.py

class ProfileChangeView(LoginRequiredMixin, View):
    """プロフィール変更画面のビュー"""

    def post(self, request, *args, **kwargs):
        # フォームオブジェクトを作成
        form = ProfileChangeForm(request.POST, request.FILES, instance=request.user)
        # バリデーションを実行
        if not form.is_valid():
            context = {
                'form': form,
            }
            return TemplateResponse(request, 'accounts/profile_change.html', context)
        # 変更を保存(MEDIA_LOOTのディレクトリに保存される)
        form.save()
        # フラッシュメッセージを画面に表示
        messages.info(request, "プロフィール画像を変更しました")
        return HttpResponseRedirect('/accounts/profile_change/')
```
- ファイルをアップロードするには、HTMLの<form>に`enctype="multipart/form-data"`を記述する必要がある
- 画像ファイルをテンプレートで表示するには以下のようにする（モデルの`FileField`や`ImageField`のurl属性を使用）
```
{% load static %}

{% if user.profile_image %}
    <img src="{{ user.profile_image.url }}">
{% else %}
    <img src="{{ static 'accounts/images/no-image.png' }}">
{% endif %}
```
- 以下のようにすると、開発環境（`DEBUG=True`）でメディアファイルの動作確認ができる
```
# config.urls.py
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    ...
    # settingのMEDIA_URLにアクセスするとMEDIA_ROOTから画像を探す
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT) \
  + static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)

# settings.py
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

# ↓
# http://localhost:8000/media/xxx.jpgで画像を表示できる
```

#### データベース

- `setting.py`の`DATABASES`に`ATOMIC_REQUESTS = True`を設定すると、トランザクション有効範囲をビューの開始から終了までにできる

#### ロギング

- ログ出力に関する設定を行う。本番運用時と開発時で設定を分ける。`if DEBUG`で書き分けてもよいが、ベストプラクティスは開発環境の設定を分けること。


#### テンプレート

- `TEMPLATES`に以下の設定をすることで、ベースディレクトリ直下の`templates`ディレクトリを探してくれる
```
'DIRS': [BASE_DIR / 'templates'],
```

#### LANGUAGE_CODE（言語コード）

- 日本語表示へ変換（管理サイトなど
```
LANGUAGE_CODE = 'ja'
```

#### TIME_ZONE（タイムゾーン）

- 日本標準時（JST）に変更するのが通例
```
TIME_ZONE = 'Asia/Tokyo'
USE_TZ = True
```
- TIME_ZONEへの変換は、テンプレートへのレンダリングまたは、リクエストパラメータをフォームオブジェクトに変換する際に行われる

#### ALLOWED_HOSTS（許可するホスト）

- セキュリティ対策のため、Djangoサイトを配信するときのホストを指定する
- `DEBUG = False`のときには設定が必須となる


#### SECRET_KEY（シークレットキー）

- 暗号署名やハッシュ生成時に利用されるシークレットな文字列
- 環境ごとに固有であることが望ましいため、テスト環境から本番環境へ移行時に新しくする


#### SITE_ID（サイトID）

- Djangoプロジェクトを識別するためのIDで、Djangoパッケージによっては設定が必須となるので注意する


#### 個人の開発環境の設定を分ける

- 設定ファイルには本番用の設定が書かれているべきであるため、本番用と開発用のファイルは分けた方がよい
- `settings.py`の内容を読み込んだ個人用の設定ファイル`local_settings.py`を使ってrunserverを起動することで、環境を分けられる
```
from .settings import * 

DEBUG = True  

ALLOWED_HOSTS = ['*']  

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',  
        'NAME': BASE_DIR/ 'db.sqlite3',  
    }  
} 
```
- 以下のコマンドで起動する
```
$ python3 manage.py runserver --settings config.local_settings 
```
- 階層は、`config`ディレクトリ→`settings`ディレクトリ→それぞれの環境のディレクトリとする
- 

#### シークレットな変数の扱い方

- シークレットな変数は.envファイルに書くようにする（機密性が高いため、バージョン管理下に置かない）
- 「django-environ」というDjangoパッケージを利用すると環境変数やファイルに書かれた変数を読み込むことができる


### データベースのマイグレーション

- モデルの変更差分をチェックしてマイグレーションファイルを作成する
```
$ python3 manage.py makemigrations (アプリケーション名・省略可)
```
- 設定ファイルで定義したデータベースに、マイグレーションファイルの内容を反映してテーブルを作成・変更
```
$ python3 manage.py makemigration
```
- 変更内容をデータベースに反映する
```
$ python3 manage.py migrate (アプリケーション名・省略可)
```
- データベースの状態は、マイグレーションファイルを元にして、戻すことができる。どうしても戻せない場合は、データベースを最初から作り直す。


### 開発用サーバー

- runserverは本番環境では絶対に使わない
- 開発用サーバーを起動する
```
python3 manage.py runserver (ポート番号・省略可)
```

### 管理サイト

- `プロジェクト/urls.py`に管理サイトのURLを設定する
```
from django.urls import path  
from django.contrib import admin  

urlpatterns = [
	  path('admin/', admin.site.urls),  
] 
```
- `shop/admin.py`にモデル名を設定する
```
from django.contrib import admin
from .models import Publisher, Author, Book

admin.site.register(Publisher)
admin.site.register(Author)
admin.site.register(Book)
```
- `django.contrib.auth（認証システム）`アプリケーションが有効になっている場合はGroupモデルとUserモデルが管理サイトに自動的に登録されるため、改めての登録は不要。

- DBのマイグレーション実行後、以下のコマンドでsuperuserを作成する（パスワードなども設定する）
```
$ python manage.py createsuperuser
```
- サーバーを立ち上げ、`http://127.0.0.1:8000/admin/login/`にアクセスし、作成したユーザーでログインする
- `アプリ名/admin.py`に設定することで、管理画面をカスタマイズしたり、バリデーションを設定することができる





## 次やること
- 現場で使えるDjangoの教科書


## 感じたこと

設定ファイルの書き方について、知らない設定があったので詳しく学べてよかったです。

## 学習時間
今日:6h
今週:37.5h 
累計:782h