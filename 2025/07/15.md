## 取り組んだ課題一覧
- SQL
	- スッキリわかるSQL入門
		- 問題集
	- 達人に学ぶDB設計

	
## わかったこと

### 一歩進んだ論理設計

- リレーショナルデータベースでツリー構造を扱うには、主に隣接リストモデルと閉包テーブルモデルを使用する
- DBMSが再帰共通表式をサポートしていれば、隣接リストモデルを使うのが良い

#### 隣接リストモデル

- ノードのレコードに親ノードの情報（ポインタ）を持たせる方法
- ポインタの列は、親ノードの列への外部キーとする（参照整合性制約をつける）
- 隣接リストモデルは長らくアンチパターンと考えられてきたが、再帰共通表式（再帰的に入れ子の検索を行う）がDBMSでサポートされるようになったことで使われるようになった
- 再帰が万人に受け入れられるか、大規模なツリー構造で性能が出るかは今後の検証が必要

```
-- 再帰共通表式
-- Traversal:再帰名

WITH RECURSIVE Traversal (emp, boss, depth) AS (
    -- 開始点となるクエリ（アンカー部）
        SELECT
        O1.emp,
        O1.boss,
        1 AS depth  -- depth(階層)に1を設定
    FROM OrgChartAdjacency O1
    -- bossがNULLのレコードを取得 = 'アダム'
    WHERE O1.boss IS NULL

    UNION ALL  -- 再帰の結果をTraversal に追加

    -- 再帰的に繰り返すクエリ（再帰部）
    SELECT  -- 見つかった結果を返す
        O2.emp,
        O2.boss,
        (T.depth + 1) AS depth   -- 前回のdepth(階層)に1を足す
    FROM OrgChartAdjacency O2
    INNER JOIN Traversal T  -- 直前の結果の一時テーブルをJOIN
        -- T.empをbossに持つ人（T.empの部下）を探す
        ON T.emp = O2.boss
)

SELECT emp, boss, depth
-- 累積結果テーブルを返す
FROM Traversal;
```

- 内部ノードの削除は、まず削除する直下のノードを親へ付け替えて、削除対象のノードを削除する
- ノードの挿入は、対象の親ノードへつけて、親直下のノードを対象ノードへつけかえる

#### 閉包テーブルモデル

- マスタとノードの関係を設定した２つのテーブルを使用する
- ノードのテーブルには、ルートから全ての配下のノードを設定する
- 階層は再帰を使わずカウントで出せる
- ノードの削除は２つのテーブルで行う必要がある
- ノードの挿入は対象をパスに含むレコードの書き換えが必要


### SQL

```
-- 集計関数() OVER (PARTITION BY 列名)

-- 列名ごとに行をグループ分けし、そのグループ内の件数を行ごとに表示する
COUNT(*) OVER (PARTITION BY 列名)
```



## 次やること
- 達人に学ぶDB設計
    - ブログ作成
- スッキリわかるSQL入門
    - 問題集


## 感じたこと
 再帰共通表式のSQL文の理解に時間がかかりました。ツリー構造はメッセージの返信機能のデータ保管などにも使えることがわかりました。



## 学習時間
今日:7h
今週:27h 
累計:628h